// client/src/api/geocoding.js

import axios from 'axios';

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –ö–õ–Æ–ß API 2–ì–ò–°
const DG_API_KEY = '1c9b97fd-86fb-4861-a340-12600c03385b';

// –ò—Å–ø–æ–ª—å–∑—É–µ–º endpoint –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è/–ø–æ–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
// –≠—Ç–æ—Ç endpoint –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å –∏ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
const GEOCODING_URL = 'https://catalog.api.2gis.ru/3.0/items/geocode';


/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –≤–≤–æ–¥—É –∞–¥—Ä–µ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è 2–ì–ò–°.
 * –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Google, 2–ì–ò–° –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—É—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–∏—Å–∫–∞.
 * * @param {string} query - –ß–∞—Å—Ç–∏—á–Ω–æ –≤–≤–µ–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
 * @returns {Array} –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∞–¥—Ä–µ—Å –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
 */
export const fetchAddressSuggestions = async (query) => {
    if (query.length < 3) return [];

    try {
        const response = await axios.get(GEOCODING_URL, {
            params: {
                q: query,
                key: DG_API_KEY,
                fields: 'items.point',
                page: 1,
                page_size: 10,
                // üõë –í–´–ó–´–í–ê–ï–¢ –û–®–ò–ë–ö–£ 400. –£–î–ê–õ–Ø–ï–ú –ò–õ–ò –ö–û–ú–ú–ï–ù–¢–ò–†–£–ï–ú:
                // locale: 'ru',
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ 2–ì–ò–°
        const items = response.data.result.items || [];

        return items
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∞–¥—Ä–µ—Å
            .filter(item => item.point && item.full_name)
            .map(item => ({
                // full_name - —ç—Ç–æ –ø–æ–ª–Ω—ã–π, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
                address: item.full_name,
                lat: item.point.lat,
                lng: item.point.lon, // 2–ì–ò–° –∏—Å–ø–æ–ª—å–∑—É–µ—Ç lon –¥–ª—è –¥–æ–ª–≥–æ—Ç—ã
                id: item.id,
            }));

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è 2–ì–ò–°:", error);
        return [];
    }
};

// –§—É–Ω–∫—Ü–∏—è getGeocodeDetails –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–∞–µ–º —Å—Ä–∞–∑—É!